#include <stdio.h>
#include <fftw3.h>
#include <math.h>

#define N 240   // Số mẫu
#define Fs 20.0 // Tần số lấy mẫu (Hz)

void generateSignal(double signal[])
{
    // Tạo một tín hiệu đơn giản, ví dụ: sóng sin 5 Hz
    for (int i = 0; i < N; i++)
    {
        signal[i] = sin(2.0 * M_PI * 5.0 * i / Fs);
    }
}

int main()
{
    double signal[N] = {0x0647, 0x0649, 0x0845, 0x08C7, 0x0893, 0x084C, 0x084F, 0x082A, 0x07CC, 0x0788, 0x0756, 0x0721, 0x06EF, 0x06AD, 0x066D, 0x075E, 0x08FC, 0x08D2, 0x088F, 0x0865, 0x0860, 0x081D, 0x07C5, 0x077D, 0x074D, 0x0714, 0x06DF, 0x06A9, 0x0679, 0x0841, 0x091E, 0x08E1, 0x08A9, 0x088C, 0x086D, 0x081D, 0x07CE, 0x0797, 0x0760, 0x0727, 0x06E9, 0x06AD, 0x0678, 0x084A, 0x08FF, 0x08D9, 0x089C, 0x087D, 0x0859, 0x080A, 0x07C5, 0x078A, 0x074E, 0x0712, 0x06D6, 0x0698, 0x0666, 0x07EB, 0x08C9, 0x08A1, 0x0860, 0x083D, 0x081A, 0x07C7, 0x0778, 0x0741, 0x0710, 0x06CF, 0x0696, 0x065F, 0x0660, 0x0842, 0x085F, 0x082D, 0x07DE, 0x07D6, 0x0793, 0x0745, 0x0700, 0x06D0, 0x06A5, 0x0667, 0x0630, 0x05FA, 0x06E1, 0x0845, 0x0829, 0x07F6, 0x07CA, 0x07BC, 0x0779, 0x0727, 0x06F4, 0x06C4, 0x0694, 0x0657, 0x061E, 0x05F1, 0x0766, 0x085F, 0x0835, 0x07FC, 0x07E4, 0x07CA, 0x0780, 0x0737, 0x0704, 0x06D8, 0x06A9, 0x0673, 0x063C, 0x0612, 0x07B0, 0x088E, 0x086B, 0x082E, 0x081C, 0x07FF, 0x07C0, 0x077C, 0x0747, 0x0727, 0x06F0, 0x06BC, 0x068C, 0x0655, 0x0797, 0x08E0, 0x08C0, 0x088C, 0x0870, 0x085F, 0x081B, 0x07D7, 0x07A1, 0x0777, 0x0745, 0x0714, 0x06DC, 0x06A4, 0x0723, 0x08DF, 0x08E4, 0x08BE, 0x0878, 0x0875, 0x0842, 0x07F3, 0x07BB, 0x078D, 0x075D, 0x0726, 0x06F5, 0x06F6, 0x08B1, 0x08FF, 0x08DC, 0x088C, 0x0873, 0x0848, 0x07F4, 0x07B0, 0x077E, 0x0748, 0x070D, 0x06D2, 0x06A0, 0x0719, 0x08DD, 0x08CB, 0x08A6, 0x0867, 0x0854, 0x0816, 0x07C8, 0x0790, 0x0768, 0x0738, 0x06F9, 0x06CA, 0x0696, 0x0740, 0x08EE, 0x08D8, 0x08B6, 0x0875, 0x0866, 0x081F, 0x07D3, 0x079C, 0x0777, 0x0748, 0x070D, 0x06D8, 0x06AB, 0x06B4, 0x0896, 0x08FA, 0x08E1, 0x0899, 0x088B, 0x0861, 0x080F, 0x07D3, 0x07AB, 0x0780, 0x0746, 0x0708, 0x06DC, 0x06E1, 0x08B1, 0x0912, 0x08F2, 0x08B8, 0x08D0, 0x08AC, 0x085A, 0x0835, 0x0837, 0x085E, 0x08F1, 0x090F, 0x093F, 0x09CF, 0x0ADD, 0x0AFE, 0x0AF4, 0x0AC3, 0x0AA9, 0x0A68, 0x0A1F, 0x09DE, 0x099F, 0x096B, 0x0924, 0x08E1, 0x08AD, 0x08C7, 0x09E4, 0x0A12};
    // generateSignal(signal);
    for (int i = 0; i < sizeof(signal) / sizeof(double); i++)
        signal[i] = signal[i] - 2000;
    // Sử dụng FFTW để tính DFT
    fftw_complex *fft_result;
    fft_result = (fftw_complex *)fftw_malloc(N * sizeof(fftw_complex));

    fftw_plan plan = fftw_plan_dft_r2c_1d(N, signal, fft_result, FFTW_ESTIMATE);
    fftw_execute(plan);
    fftw_destroy_plan(plan);

    double Frequency_heart_rate = 0;
    double Magnitude_heart_rate = 0;
    // In kết quả
    printf("DFT Result:\n");
    for (int k = 0; k < N / 2; k++)
    {
        double freq = (double)k * Fs / N;
        double magnitude = sqrt(fft_result[k][0] * fft_result[k][0] + fft_result[k][1] * fft_result[k][1]);
        printf("Frequency %.2f Hz: Magnitude %.2f\n", freq, magnitude);
        if(magnitude>Magnitude_heart_rate)
        {
            Magnitude_heart_rate = magnitude;
            Frequency_heart_rate = freq;
        }
    }

    printf("Heart rate %lf\r\n",Frequency_heart_rate*60);

    fftw_free(fft_result);

    return 0;
}
